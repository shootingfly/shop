SOCKETS = [] of HTTP::WebSocket
ID      = [] of Int32
ws "/chat" do |socket, env|
  qq = env.params.query["qq"]
  name = env.params.query["name"]
  room_id = env.params.query["room_id"]
  file_name = "./public/#{room_id}.txt"
  `touch #{file_name}` unless File.exists?("./public/#{room_id}.txt")
  more = File.read(file_name)
  socket.send(more)
  SOCKETS << socket
  ID << room_id.to_i
  socket.on_message do |message|
    str = <<-END
<div class="mdui-col-xs-12 mdui-card">
  <div class="mdui-card-header">
    <img class="mdui-card-header-avatar" src="http://q4.qlogo.cn/g?b=qq&nk=#{qq}&s=100"/>
    <div class="mdui-card-header-title">#{name}</div>
    <div class="mdui-card-header-subtitle">#{Time.now.to_s("%m-%d %H:%M")}</div>
  </div>
  <!-- 卡片的内容 -->
  <div class="mdui-card-content">#{message}子曰：「学而时习之，不亦说乎？有朋自远方来，不亦乐乎？人不知，而不愠，不亦君子乎？」</div>
</div>
END
    File.open(file_name, "a+") { |f| f.puts(str) }
    # time = Time.now.to_s("%m-%d %H:%M")
    ID.each_with_index do |id, i|
      SOCKETS[i].send(str) if id == room_id
    end
    # SOCKETS[].each { |socket| socket.send(str) }
  end
  socket.on_close do
    SOCKETS.delete socket
  end
end

get "/chatform" do |env|
  view "chat_form", "开房表单"
end

post "/chat" do |env|
  qq = env.params.body["qq"]
  name = env.params.body["name"]
  room_id = env.params.body["room_id"]
  view "chat", "告白小空间"
end
